<!DOCTYPE html>
<html>
<head>
  <title>NC Bike/Pedestrian Counts</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=yes" />
 
  <style>
    /* CSS styles */
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #f7f9fc;
      color: #333;
    }
    h1 {
      text-align: center;
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    #text {
      text-align: center;
      margin-top: 10px;
      font: italic 14px 'Segoe UI', sans-serif;
    }
    #map {
      position: absolute;
      width: 80%;
      height: 80vh;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
    }
    .controls-container {
      position: absolute;
      top: 100px;
      left: 10px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 15px;
      padding: 20px;
      width: 280px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      opacity: .8;
    }
    .controls input[type="range"] {
      width: 100%;
    }
    .dateselect input[type="date"] {
      width: 48%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    select, label {
      font-size: 14px;
      margin-top: 6px;
    }
   
    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
   
    .search-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1000;
    }

    .search-wrapper {
      position: relative;
      width: 400px;
    }

    #searchBar {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 25px;
      outline: none;
      transition: border-color 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      top: 10px;
      
    }

    #searchBar:focus {
      border-color: #00bcd4;
      box-shadow: 0 2px 15px rgba(0,188,212,0.3);
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 15px 15px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .search-results.show {
      display: block;
    }

    .search-result-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s ease;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background-color: #f0f7ff;
    }

    .search-result-item.selected {
      background-color: #e6f7ff;
    }

    .search-result-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
    }

    .search-result-details {
      font-size: 12px;
      color: #666;
    }

    .search-clear {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 18px;
      color: #999;
      cursor: pointer;
      display: none;
    }

    .search-clear:hover {
      color: #666;
    }
   
    .counter-item {
      padding: 6px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
   
    .counter-item:last-child {
      border-bottom: none;
    }
   
    .counter-item.selected {
      background-color: #e6f7ff;
      font-weight: bold;
    }
   
    .counter-item.highlighted {
      background-color: #f0f7ff;
    }
   
    .stats-container {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #e9ecef;
    }
   
    .stats-container p {
      margin: 5px 0;
      font-size: 14px;
    }
   
    .export-import {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }
   
    .counter-info {
      position: absolute;
      top: 100px;
      right: 20px;
      z-index: 100;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      max-width: 300px;
      display: none;
    }

    .download-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .download-btn {
      background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,188,212,0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
      justify-content: center;
    }

    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,188,212,0.4);
      background: linear-gradient(135deg, #0097a7 0%, #00838f 100%);
    }

    .download-options {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      padding: 10px 0;
      min-width: 200px;
      display: none;
      margin-bottom: 10px;
    }

    .download-options.show {
      display: block;
    }

    .download-option {
      padding: 12px 20px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .download-option:hover {
      background-color: #f0f7ff;
    }

    .download-option-title {
      font-weight: 600;
      color: #333;
    }

    .download-option-desc {
      font-size: 12px;
      color: #666;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none;
    }

    .loading-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00bcd4;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: #333;
      font-weight: 600;
    }
    
  </style>
 
  <script>
    let markers = []; // Global array to hold markers shown on the map
    let counters = []; // Global counters array
    let geocoder; // For address search
    let currentSelectedCounter = null; // selected counter 
    let downloadInProgress = false; // Flag to prevent multiple downloads
  </script>
 
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://unpkg.com/@mapbox/mapbox-gl-geocoder@4.7.0/dist/mapbox-gl-geocoder.css" rel="stylesheet" />
  <script src="https://unpkg.com/@mapbox/mapbox-gl-geocoder@4.7.0/dist/mapbox-gl-geocoder.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <div class="header">
    <h1>North Carolina Bike and Pedestrian Counts</h1>
    <p id="text">Double click counters for detailed analysis</p>
    
    <div class="search-container">
      <div class="search-wrapper">
        <input type="text" id="searchBar" placeholder="Search for counters, addresses, or locations...">
        <button class="search-clear" id="searchClear">&times;</button>
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>
  </div>
  
  <div id="map"></div>
  <div id="counterInfo" class="counter-info"></div>
  
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Downloading data. Please wait...</div>
    </div>
  </div>
  
  <!-- Download Controls -->
  <div class="download-container">
    <div class="download-options" id="downloadOptions">
      <div class="download-option" data-format="json">
        <div>
          <div class="download-option-title">JSON Format</div>
        </div>
      </div>
      <div class="download-option" data-format="csv">
        <div>
          <div class="download-option-title">CSV Format</div>
        </div>
      </div>
    </div>
    <button class="download-btn" id="downloadBtn">
      <span></span>
      <span>Download Counters Metadata</span>
    </button>

    <button class="download-btn" id="downloadCountsBtn" style="display: none;">
      <span></span>
      <span>Download Counts / Datastreams</span>
    </button>
  </div>
  
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script>
    // Initialize map
    mapboxgl.accessToken = ''; // Mapbox access token
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-79, 35.7],
      zoom: 9
    });
   
    // Add navigation controls
    map.addControl(new mapboxgl.NavigationControl());

    // Initialize geocoder for address search (not working)
    geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl,
      countries: 'us',
      bbox: [-84.3219, 33.7529, -75.4606, 36.5880], // North Carolina bounds
      proximity: {
        longitude: -79,
        latitude: 35.7
      }
    });
   
    // Set bounds for North Carolina
    map.on('load', () => {
      map.setMaxBounds([
        [-84.3219, 33.7529],
        [-75.4606, 36.5880]
      ]);
     
      
      map.addSource('states', {
        type: 'vector',
        url: 'mapbox://mapbox.us-states-v1'
      });
    });

    // *******Search functionality**************
    let searchTimeout;
    let selectedSearchIndex = -1;

    function performSearch(query) {
      const searchResults = document.getElementById('searchResults');
      const clearButton = document.getElementById('searchClear');
      
      if (!query.trim()) {
        searchResults.classList.remove('show');
        clearButton.style.display = 'none';
        return;
      }

      clearButton.style.display = 'block';
      
      // Search through counters
      const counterResults = counters.filter(counter => 
        counter.counter_name.toLowerCase().includes(query.toLowerCase()) ||
        counter.counter_id.toString().includes(query) ||
        (counter.counter_notes && counter.counter_notes.toLowerCase().includes(query.toLowerCase())) ||
        (counter.vendor && counter.vendor.toLowerCase().includes(query.toLowerCase()))
      );

      let resultsHTML = '';
      
      // Add counter results
      counterResults.forEach((counter, index) => {
        resultsHTML += `
          <div class="search-result-item" data-type="counter" data-id="${counter.counter_id}" data-index="${index}">
            <div class="search-result-title">${counter.counter_name}</div>
            <div class="search-result-details">
              ID: ${counter.counter_id} | ${counter.vendor || 'Unknown vendor'}
              ${counter.counter_notes ? ' | ' + counter.counter_notes.substring(0, 50) + (counter.counter_notes.length > 50 ? '...' : '') : ''}
            </div>
          </div>
        `;
      });

      // Add address search option if the search looks like an address
      if (query.length > 3 && /[a-zA-Z]/.test(query)) {
        resultsHTML += `
          <div class="search-result-item" data-type="address" data-query="${query}" data-index="${counterResults.length}">
            <div class="search-result-title">Search "${query}" as address</div>
            <div class="search-result-details"></div>
          </div>
        `;
      }

      if (resultsHTML) {
        searchResults.innerHTML = resultsHTML;
        searchResults.classList.add('show');
        selectedSearchIndex = -1;
      } else {
        searchResults.innerHTML = '<div class="search-result-item"><div class="search-result-title">No results found</div></div>';
        searchResults.classList.add('show');
      }
    }

    function selectSearchResult(element) {
      const type = element.getAttribute('data-type');
      const searchBar = document.getElementById('searchBar');
      const searchResults = document.getElementById('searchResults');

      if (type === 'counter') {
        const counterId = parseInt(element.getAttribute('data-id'));
        const counter = counters.find(c => c.counter_id === counterId);
        
        if (counter) {
          // Zoom to counter
          map.easeTo({
            center: [counter.longitude, counter.latitude],
            zoom: 15,
            duration: 1000
          });

          // Show counter info
          showCounterInfo(counter);

          // Update search bar
          searchBar.value = counter.counter_name;
          
          // Highlight the marker
          highlightMarker(counter);
        }
      } 
      // Search address using geocode (not working)
      else if (type === 'address') {
        const query = element.getAttribute('data-query');
        
        
        geocoder.query(query);
        geocoder.on('result', function(e) {
          const result = e.result;
          map.easeTo({
            center: result.center,
            zoom: 14,
            duration: 1000
          });
          
          // Add a temporary marker for the address (not working)
          const addressMarker = new mapboxgl.Marker({color: 'red'})
            .setLngLat(result.center)
            .setPopup(new mapboxgl.Popup().setText(result.place_name))
            .addTo(map);
          
          // Remove the marker after 10 seconds
          setTimeout(() => {
            addressMarker.remove();
          }, 10000);
          
          searchBar.value = result.place_name;
        });
      }

      searchResults.classList.remove('show');
    }

    function highlightMarker(counter) {
      // Reset all markers first
      markers.forEach(marker => {
        const el = marker.getElement();
        el.style.width = '10px';
        el.style.height = '10px';
        el.style.backgroundColor = '#2C3E50';
        el.style.background = 'linear-gradient(135deg, #2C3E50 0%, #34495E 100%)';
      });

      // Find and highlight the specific marker
      const targetMarker = markers.find(marker => {
        const lngLat = marker.getLngLat();
        return Math.abs(lngLat.lng - counter.longitude) < 0.0001 && 
               Math.abs(lngLat.lat - counter.latitude) < 0.0001;
      });

      if (targetMarker) {
        const el = targetMarker.getElement();
        el.style.width = '20px';
        el.style.height = '20px';
        el.style.backgroundColor = '#C0392B';
        el.style.background = 'linear-gradient(135deg, #C0392B 0%, #E74C3C 100%)';
      }
    }

    // Search event listeners
    document.getElementById('searchBar').addEventListener('input', function(e) {
      const query = e.target.value;
      
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        performSearch(query);
      }, 300);
    });

    // Keyboard navigation for search results
    document.getElementById('searchBar').addEventListener('keydown', function(e) {
      const searchResults = document.getElementById('searchResults');
      const items = searchResults.querySelectorAll('.search-result-item');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedSearchIndex = Math.min(selectedSearchIndex + 1, items.length - 1);
        updateSearchSelection(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedSearchIndex = Math.max(selectedSearchIndex - 1, -1);
        updateSearchSelection(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedSearchIndex >= 0 && items[selectedSearchIndex]) {
          selectSearchResult(items[selectedSearchIndex]);
        }
      } else if (e.key === 'Escape') {
        searchResults.classList.remove('show');
        selectedSearchIndex = -1;
      }
    });

    function updateSearchSelection(items) {
      items.forEach((item, index) => {
        if (index === selectedSearchIndex) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }
    // Clear search functionality
    document.getElementById('searchClear').addEventListener('click', function() {
      const searchBar = document.getElementById('searchBar');
      const searchResults = document.getElementById('searchResults');
      const clearButton = document.getElementById('searchClear');
      
      searchBar.value = '';
      searchResults.classList.remove('show');
      clearButton.style.display = 'none';
      selectedSearchIndex = -1;
      
      // Reset all markers
      markers.forEach(marker => {
        const el = marker.getElement();
        el.style.width = '10px';
        el.style.height = '10px';
        el.style.backgroundColor = '#2C3E50';
        el.style.background = 'linear-gradient(135deg, #2C3E50 0%, #34495E 100%)';
      });
      
      // Hide counter info
      document.getElementById('counterInfo').style.display = 'none';
    });

    // Click outside to close search results
    document.addEventListener('click', function(e) {
      const searchContainer = document.querySelector('.search-wrapper');
      const searchResults = document.getElementById('searchResults');
      
      if (!searchContainer.contains(e.target)) {
        searchResults.classList.remove('show');
        selectedSearchIndex = -1;
      }
    });

    // Handle clicks on search results
    document.addEventListener('click', function(e) {
      if (e.target.closest('.search-result-item')) {
        selectSearchResult(e.target.closest('.search-result-item'));
      }
    });
   
    // Fetch counters from the API
    fetch('http://localhost:8000/counters/')
      .then(response => {
        if (!response.ok) throw new Error('Not working');
        return response.json();
      })
      .then(data => {
        counters = data;
        addCountersToMap();
      })
      .catch(error => {
        console.error('Problem fetching counters:', error);
      });
   
    // Add counters to the map
    function addCountersToMap() {
      counters.forEach(counter => {
        let el = document.createElement('div');
        el.className = 'marker';

        el.style.width = '10px';
        el.style.height = '10px';
        el.style.borderRadius = '50%';
        el.style.backgroundColor = '#2C3E50'; 
        el.style.background = 'linear-gradient(135deg, #2C3E50 0%, #34495E 100%)'; 
        el.style.border = 'none'; 
        el.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.2)'; 
        el.style.cursor = 'pointer'; 
       
        // Double click a counter to open the dashboard
        el.ondblclick = () => {
          const sensorId = Number(counter.counter_id);
          const url = `http://localhost:8088/superset/dashboard/p/1mGgqwnrz9A/?native_filters=(NATIVE_FILTER-_ox7CwuuBQK-dowCoOPTB:(__cache:(label:'${sensorId}',validateStatus:!f,value:!('${sensorId}')),extraFormData:(filters:!((col:counter_id,op:IN,val:!('${sensorId}')))),filterState:(label:'${sensorId}',validateStatus:!f,value:!('${sensorId}')),id:NATIVE_FILTER-_ox7CwuuBQK-dowCoOPTB,ownState:()))`;
          
          //Helpful link to understand how this works: https://www.blef.fr/superset-filters-in-url/


          
          window.open(url, '_blank');
        };
       
        // Single click to select, el = the marker on the map
        el.onclick = () => {
          // Reset markers
          markers.forEach(marker => {
            const markerEl = marker.getElement();
            markerEl.style.width = '10px';
            markerEl.style.height = '10px';
            markerEl.style.backgroundColor = '#2C3E50';
            markerEl.style.background = 'linear-gradient(135deg, #2C3E50 0%, #34495E 100%)';
          });

          el.style.width = '20px';
          el.style.height = '20px';
          el.style.backgroundColor = '#C0392B'; 
          el.style.background = 'linear-gradient(135deg, #C0392B 0%, #E74C3C 100%)'; 

          // Zoom to the marker location when clicked
          map.easeTo({
            center: [counter.longitude, counter.latitude], 
            zoom: 15, 
            duration: 1000, 
            easing: (t) => t 
          });

          //Option to download counts/datastreams
          currentSelectedCounter = counter;
          document.getElementById('downloadCountsBtn').style.display = 'block';

          showCounterInfo(counter);
        };

        // Create a marker and add it to the map
        let marker = new mapboxgl.Marker(el)
          .setLngLat([counter.longitude, counter.latitude])
          .setPopup(new mapboxgl.Popup().setText(counter.counter_name))
          .addTo(map);
       
        markers.push(marker);
      });
    }
   
    // Show counter information
    function showCounterInfo(counter) {
      const infoPanel = document.getElementById('counterInfo');
      infoPanel.innerHTML = `
        <h3>${counter.counter_name}</h3>
        <p>ID: ${counter.counter_id}</p>
        <p>Latitude: ${counter.latitude.toFixed(4)}</p>
        <p>Longitude: ${counter.longitude.toFixed(4)}</p>
        <p>Vendor: ${counter.vendor}</p>
        <p>Counter notes: ${counter.counter_notes}</p>
      `;
      infoPanel.style.display = 'block';
    }

    // Click outside to close counter info
    document.addEventListener('click', (event) => {
      const infoPanel = document.getElementById('counterInfo');
      const markersContainer = document.querySelectorAll('.marker');
      const searchContainer = document.querySelector('.search-wrapper');
      const downloadContainer = document.querySelector('.download-container');
      
      const clickedInsidePanel = infoPanel.contains(event.target);
      const clickedInsideMarker = Array.from(markersContainer).some(marker =>
        marker.contains(event.target)
      );
      const clickedInsideSearch = searchContainer.contains(event.target);
      const clickedInsideDownload = downloadContainer.contains(event.target);

      if (!clickedInsidePanel && !clickedInsideMarker && !clickedInsideSearch && !clickedInsideDownload) {
        infoPanel.style.display = 'none';
        
        if(!downloadInProgress){
          currentSelectedCounter = null;
          document.getElementById('downloadCountsBtn').style.display = 'none';
        }
        
        // Reset all markers
        markers.forEach(marker => {
          const el = marker.getElement();
          el.style.width = '10px';
          el.style.height = '10px';
          el.style.backgroundColor = '#2C3E50';
          el.style.background = 'linear-gradient(135deg, #2C3E50 0%, #34495E 100%)';
        });
      }
    });

    // ********Download functionality****************
    function downloadData(format) {
      const timestamp = new Date().toISOString().split('T')[0];
      let filename, content, mimeType;

      switch (format) {
        case 'json':
          filename = `nc_counters_${timestamp}.json`;
          content = JSON.stringify(counters, null, 2);
          mimeType = 'application/json';
          break;

        case 'csv':
          filename = `nc_counters_${timestamp}.csv`;
          content = convertToCSV(counters);
          mimeType = 'text/csv';
          break;

        default:
          console.error('Unknown format:', format);
          return;
      }

      //  trigger download
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      
      document.getElementById('downloadOptions').classList.remove('show');
    }

    function convertToCSV(data) {
      if (!data || data.length === 0) return '';

     
      const keys = [...new Set(data.flatMap(Object.keys))];
      
     
      const header = keys.join(',');
      
      
      const rows = data.map(item => {
        return keys.map(key => {
          let value = item[key];
          
          
          if (value === null || value === undefined) {
            value = '';
          }
          
         
          value = String(value).replace(/"/g, '""');
          
        
          if (value.includes(',') || value.includes('\n') || value.includes('"')) {
            value = `"${value}"`;
          }
          
          return value;
        }).join(',');
      });

      return [header, ...rows].join('\n');
    }

   
    document.getElementById('downloadBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      const options = document.getElementById('downloadOptions');
      options.classList.toggle('show');
    });

    document.querySelectorAll('.download-option').forEach(option => {
      option.addEventListener('click', function(e) {
        e.stopPropagation();
        const format = this.getAttribute('data-format');
        downloadData(format);
      });
    });

    // Handle download for counts/datastreams
    async function downloadCounterData() {
      if (!currentSelectedCounter || downloadInProgress) return;
      
      downloadInProgress = true;
      const counterId = currentSelectedCounter.counter_id;
      
      try {
        // loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.display = 'flex';
        
        
        document.getElementById('downloadBtn').disabled = true;
        document.getElementById('downloadCountsBtn').disabled = true;
        
        // Fetch datastreams from API
        const datastreamsResponse = await fetch(`http://localhost:8000/counters/${counterId}/datastreams/`);
        const datastreamsData = await datastreamsResponse.json();
        
       
        const datastreamIds = datastreamsData.map(ds => ds.datastream_id);
        
        // Fetch counts for all datastreams
        const countsPromises = datastreamIds.map(datastreamId => 
          fetch(`http://localhost:8000/datastreams/${datastreamId}/counts`)
            .then(response => response.json())
            .then(counts => ({ datastreamId, counts }))
        );
        
        const allCountsResults = await Promise.all(countsPromises);
        
        // Combine  counts
        const allCounts = allCountsResults.flatMap(result => 
          result.counts.map(count => ({
            ...count,
            datastream_id: result.datastreamId
          }))
        );
        
        // Create zip file
        const zip = new JSZip();
        zip.file(`counter_${counterId}_datastreams.json`, JSON.stringify(datastreamsData, null, 2));
        zip.file(`counter_${counterId}_counts.json`, JSON.stringify(allCounts, null, 2));
        
        //  separate files for each datastream
        allCountsResults.forEach(result => {
          zip.file(`counter_${counterId}_datastream_${result.datastreamId}_counts.json`, 
                   JSON.stringify(result.counts, null, 2));
        });
        
        //  download zip
        const content = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = `counter_${counterId}_data.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
      } catch (error) {
        console.error('Download failed:', error);
        alert('Failed to download counter data');
      } finally {
    
        document.getElementById('downloadBtn').disabled = false;
        document.getElementById('downloadCountsBtn').disabled = false;
        
       
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.display = 'none';

        
        downloadInProgress = false;
      }
    }

    document.getElementById('downloadCountsBtn').addEventListener('click', downloadCounterData);
  </script>
</body>
</html>
